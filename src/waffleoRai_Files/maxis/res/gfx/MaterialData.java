/*-----------------------------------------------------
 * Autogenerated Java class from XML definition.
 * Created Sat, 18 Jan 2025 21:02:33 -0600
 *-----------------------------------------------------*/

package waffleoRai_Files.maxis.res.gfx;

import java.io.IOException;
import java.io.Writer;
import java.util.ArrayList;
import java.util.List;

import org.w3c.dom.Element;

import waffleoRai_Containers.maxis.MaxisResKey;
import waffleoRai_Files.XMLReader;
import waffleoRai_Files.maxis.ts3enum.gfx.MaterialRecordDataType;
import waffleoRai_Files.maxis.ts3enum.gfx.ShaderParam;
import waffleoRai_Utils.BufferReference;
import waffleoRai_Utils.FileBuffer;
import waffleoRai_Utils.StringUtils;

public class MaterialData{
	
	public static final String XML_NODE_NAME = "MaterialData";
	public static final int BASE_SIZE = 4;

	public ArrayList<MatElement> elements = new ArrayList<MatElement>();

	public MaterialData() {}
	
	/*----- Inner Classes -----*/
	
	public static class MatElement{
		
		public static final String XML_NODE_NAME = "MatElement";
		public static final int INFO_BIN_SIZE = 16;
		
		private static final String XMLKEY_PARAMNAMEHASH = "Param";
		private static final String XMLKEY_DATATYPE = "DataType";
		
		private static final String XMLKEY_DATA = "MatData";
		
		public int paramNameHash;
		public int dataType;
		public int dataSize;
		public int dataOffset;
		
		//Union
		public float[] floatData;
		public int[] intData;
		public int tgiRefIndex;
		public MaxisResKey tgiRef;
		
		/*----- Read -----*/
		
		protected boolean readXMLNode_internal(Element xml_element) {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(XML_NODE_NAME)) return false;
			
			String aval = null;
			aval = xml_element.getAttribute(XMLKEY_PARAMNAMEHASH);
			if(aval != null) paramNameHash = ShaderParam.valueFromString(aval);
			aval = xml_element.getAttribute(XMLKEY_DATATYPE);
			if(aval != null) dataType = MaterialRecordDataType.valueFromString(aval);

			aval = xml_element.getAttribute(XMLKEY_DATA);
			switch(dataType) {
			case MaterialRecordDataType.D_Float:
				if(aval != null && !aval.isEmpty()) {
					aval = aval.replace("{", "");
					aval = aval.replace("}", "");
					String[] spl = aval.split(",");
					int ecount = spl.length;
					floatData = new float[ecount];
					for(int i = 0; i < ecount; i++) {
						floatData[i] = (float)Double.parseDouble(spl[i].trim());
					}
				}
				break;
			case MaterialRecordDataType.D_Int:
				if(aval != null && !aval.isEmpty()) {
					aval = aval.replace("{", "");
					aval = aval.replace("}", "");
					String[] spl = aval.split(",");
					int ecount = spl.length;
					intData = new int[ecount];
					for(int i = 0; i < ecount; i++) {
						intData[i] = StringUtils.parseSignedInt(spl[i].trim());
					}
				}
				break;
			case MaterialRecordDataType.D_Texture:
				Element child = XMLReader.getFirstChildElementWithTag(xml_element, "TextureRef");
				if(child != null) {
					aval = child.getAttribute("TableIndex");
					if(aval != null && !aval.isEmpty()) {
						tgiRefIndex = StringUtils.parseSignedInt(aval);
					}
					else {
						//Try reskey
						tgiRef = new MaxisResKey();
						tgiRef.setTypeId(StringUtils.parseUnsignedInt(child.getAttribute("TypeId")));
						tgiRef.setGroupId(StringUtils.parseUnsignedInt(child.getAttribute("GroupId")));
						tgiRef.setInstanceId(StringUtils.parseUnsignedLong(child.getAttribute("InstanceId")));
					}
				}
				break;
			}	

			return true;
		}
		
		public static MatElement readXMLNode(Element xml_element) {
			if(xml_element == null) return null;
			MatElement str = new MatElement();
			if(!str.readXMLNode_internal(xml_element)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getDataBinarySize() {
			switch(dataType) {
			case MaterialRecordDataType.D_Float:
				if(floatData == null) return 0;
				return floatData.length << 2;
			case MaterialRecordDataType.D_Int:
				if(intData == null) return 0;
				return intData.length << 2;
			case MaterialRecordDataType.D_Texture:
				if(tgiRef != null) return 20;
				return 16;
			}
			return 0;
		}
		
		public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";
			out.write(indent);
			out.write(String.format("<%s", XML_NODE_NAME));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			
			//Param and type
			out.write(String.format(" %s=\"%s\"", XMLKEY_PARAMNAMEHASH, ShaderParam.stringFromValue(paramNameHash)));
			out.write(String.format(" %s=\"%s\"", XMLKEY_DATATYPE, MaterialRecordDataType.stringFromValue(dataType)));
			
			if(dataType == MaterialRecordDataType.D_Texture) {
				//Multiline
				out.write(indent + "\t<TextureRef");
				if(tgiRef != null) {
					out.write(String.format(" TypeId=\"0x%08x\"", tgiRef.getTypeId()));
					out.write(String.format(" GroupId=\"0x%08x\"", tgiRef.getGroupId()));
					out.write(String.format(" InstanceId=\"0x%016x\"", tgiRef.getInstanceId()));
				}
				else out.write(String.format(" TableIndex=\"%d\"", tgiRefIndex));
				out.write("/>\n");
				
				out.write(String.format("</%s>\n", XML_NODE_NAME));
			}
			else {
				//Single line
				if(dataType == MaterialRecordDataType.D_Int) {
					out.write(String.format(" %s=\"{", XMLKEY_DATA));
					if(intData != null) {
						for(int i = 0; i < intData.length; i++) {
							if(i > 0) out.write(",");
							out.write(String.format("%d", intData[i]));
						}
					}
					out.write("}\"");
				}
				else if(dataType == MaterialRecordDataType.D_Float) {
					out.write(String.format(" %s=\"{", XMLKEY_DATA));
					if(floatData != null) {
						for(int i = 0; i < floatData.length; i++) {
							if(i > 0) out.write(",");
							out.write(String.format("%.4f", floatData[i]));
						}
					}
					out.write("}\"");
				}
				
				out.write("/>\n");
			}
		}
		
	}

	/*----- Read -----*/
	
	protected boolean readBinary_internal(BufferReference dat) {
		if(dat == null) return false;
		
		int elementCount = dat.nextInt();
		elements.ensureCapacity(elementCount);
		
		//Read info
		for(int i = 0; i < elementCount; i++){
			MatElement e = new MatElement();
			e.paramNameHash = dat.nextInt();
			e.dataType = dat.nextInt();
			e.dataSize = dat.nextInt();
			e.dataOffset = dat.nextInt();
			
			elements.add(e);
		}
		
		//Read data
		for(MatElement e : elements){
			switch(e.dataType) {
			case MaterialRecordDataType.D_Float:
				if(e.dataSize > 0) {
					e.floatData = new float[e.dataSize];
					for(int i = 0; i < e.dataSize; i++) {
						e.floatData[i] = Float.intBitsToFloat(dat.nextInt());
					}
				}
				break;
			case MaterialRecordDataType.D_Int:
				if(e.dataSize > 0) {
					e.intData = new int[e.dataSize];
					for(int i = 0; i < e.dataSize; i++) {
						e.intData[i] = dat.nextInt();
					}
				}
				break;
			case MaterialRecordDataType.D_Texture:
				if(e.dataSize == 4) {
					e.tgiRefIndex = dat.nextInt();
					dat.add(12L);
				}
				else {
					//Full TGI reference
					e.tgiRef = MaxisResKey.readBinITG(dat);
					dat.add(12L);
				}
				break;
			}
		}

		return true;
	}
	
	protected boolean readXMLNode_internal(Element xml_element) {
		if(xml_element == null) return false;
		String nn = xml_element.getNodeName();
		if(nn == null) return false;
		if(!nn.equals(XML_NODE_NAME)) return false;
		
		List<Element> children = XMLReader.getChildElementsWithTag(xml_element, MatElement.XML_NODE_NAME);
		int entryCount = children.size();
		if(entryCount > 0) {
			elements.ensureCapacity(entryCount);
			for(Element child : children) {
				MatElement e = MatElement.readXMLNode(child);
				if(e != null) elements.add(e);
			}
		}

		return true;
	}
	
	public static MaterialData readBinary(BufferReference dat) {
		if(dat == null) return null;
		MaterialData str = new MaterialData();
		if(!str.readBinary_internal(dat)) return null;
		return str;
	}
	
	public static MaterialData readXMLNode(Element xml_element) {
		if(xml_element == null) return null;
		MaterialData str = new MaterialData();
		if(!str.readXMLNode_internal(xml_element)) return null;
		return str;
	}
	
	/*----- Write -----*/
	
	public int getBinarySize() {
		int size = BASE_SIZE;
		size += elements.size() * MatElement.INFO_BIN_SIZE;
		for(MatElement e : elements) {
			size += e.getDataBinarySize();
		}
		return size;
	}
	
	public FileBuffer writeBinary(boolean byteOrder, int baseOffset) {
		FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
		writeBinaryTo(buff, baseOffset);
		return buff;
	}
	
	public int writeBinaryTo(FileBuffer target, int baseOffset) {
		if(target == null) return 0;
		long stPos = target.getFileSize();
		
		//First update calculations
		int elementCount = elements.size();
		int nowPos = baseOffset + (elementCount * MatElement.INFO_BIN_SIZE) + BASE_SIZE;
		for(MatElement e : elements) {
			e.dataOffset = nowPos;
			switch(e.dataType) {
			case MaterialRecordDataType.D_Float:
				if(e.floatData != null) e.dataSize = e.floatData.length;
				else e.dataSize = 0;
				break;
			case MaterialRecordDataType.D_Int:
				if(e.intData != null) e.dataSize = e.intData.length;
				else e.dataSize = 0;
				break;
			case MaterialRecordDataType.D_Texture:
				if(e.tgiRef != null) e.dataSize = 5;
				else e.dataSize = 4;
				break;
			}
			
			nowPos += (e.dataSize << 2);
		}
		
		//Now serialize
		target.addToFile(elementCount);
		for(MatElement e : elements) {
			//Info
			target.addToFile(e.paramNameHash);
			target.addToFile(e.dataType);
			target.addToFile(e.dataSize);
			target.addToFile(e.dataOffset);
		}
		for(MatElement e : elements) {
			//Data
			switch(e.dataType) {
			case MaterialRecordDataType.D_Float:
				if(e.floatData != null){
					for(int i = 0; i < e.floatData.length; i++) {
						target.addToFile(Float.floatToRawIntBits(e.floatData[i]));
					}
				}
				break;
			case MaterialRecordDataType.D_Int:
				if(e.intData != null){
					for(int i = 0; i < e.intData.length; i++) {
						target.addToFile(e.intData[i]);
					}
				}
				break;
			case MaterialRecordDataType.D_Texture:
				if(e.tgiRef != null) {
					e.tgiRef.writeBinITG(target);
					target.addToFile(0); //Weird padding.
				}
				else {
					target.addToFile(e.tgiRefIndex);
					for(int i = 0; i < 3; i++) target.addToFile(0); //Padding
				}
				break;
			}
		}

		return (int)(target.getFileSize() - stPos);
	}

	public void writeXMLNode(Writer out, String indent) throws IOException {
		writeXMLNode(out, indent, null);
	}
	
	public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
		if(out == null) return;
		if(indent == null) indent = "";
		
		out.write(indent);
		out.write(String.format("<%s", XML_NODE_NAME));
		if(varName != null){
			out.write(String.format(" VarName=\"%s\"", varName));
		}
		for(MatElement e : elements) {
			e.writeXMLNode(out, indent + "\t", null);
		}

		out.write(String.format("</%s>\n", XML_NODE_NAME));

	}

}
