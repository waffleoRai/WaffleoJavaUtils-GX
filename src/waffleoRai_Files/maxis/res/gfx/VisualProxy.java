/*-----------------------------------------------------
 * Autogenerated Java class from XML definition.
 * Created Fri, 17 Jan 2025 16:27:12 -0600
 *-----------------------------------------------------*/

package waffleoRai_Files.maxis.res.gfx;

import java.io.IOException;
import java.io.Writer;
import java.util.ArrayList;
import java.util.List;

import org.w3c.dom.Element;

import waffleoRai_Containers.maxis.MaxisResKey;
import waffleoRai_Containers.maxis.MaxisTypes;
import waffleoRai_Files.XMLReader;
import waffleoRai_Files.maxis.ts3enum.gfx.VpxyEntryType;
import waffleoRai_Utils.BufferReference;
import waffleoRai_Utils.FileBuffer;
import waffleoRai_Utils.StringUtils;

public class VisualProxy{

	private static final String XMLKEY_MAGICNO = "MagicNo";
	private static final String XMLKEY_FILEVERSION = "FileVersion";
	private static final String XMLKEY_TGIOFFSET = "TgiOffset";
	private static final String XMLKEY_TGITABLESIZE = "TgiTableSize";
	private static final String XMLKEY_ENTRYCOUNT = "EntryCount";
	private static final String XMLKEY_ASSETENTRIES = "AssetEntries";
	private static final String XMLKEY_BBTYPE = "BbType";
	private static final String XMLKEY_BOUNDINGBOX = "BoundingBox";
	private static final String XMLKEY_UNKA = "UnkA";
	private static final String XMLKEY_HASFOOTPRINT = "HasFootprint";
	private static final String XMLKEY_FTPTREFINDEX = "FtptRefIndex";
	private static final String XMLKEY_TGICOUNT = "TgiCount";
	private static final String XMLKEY_TGITABLE = "TgiTable";

	public byte[] magicNo;
	public int fileVersion;
	public int tgiOffset;
	public int tgiTableSize;
	public byte entryCount;
	public ArrayList<AssetEntry> assetEntries = new ArrayList<AssetEntry>();
	public byte bbType;
	public float[] boundingBox;
	public byte[] unkA;
	public boolean hasFootprint;
	public int ftptRefIndex;
	public byte tgiCount;
	public ArrayList<MaxisResKey> tgiTable = new ArrayList<MaxisResKey>();

	private String xmlNodeName;
	private int baseSize;

	public VisualProxy() {
		xmlNodeName = "VisualProxy";
		baseSize = 22;
	}
	
	/*----- Inner Classes -----*/

	public static class AssetEntry{

		private static final String XMLKEY_DATATYPE = "DataType";
		private static final String XMLKEY_ENTRYDATA = "EntryData";

		public byte dataType;
		public UEntryData entryData;

		private String xmlNodeName;
		private int baseSize;
	
		public AssetEntry() {
			xmlNodeName = "AssetEntry";
			baseSize = 1;
		}
		
		/*----- Read -----*/
		
		protected boolean readBinary_internal(BufferReference dat) {
			if(dat == null) return false;
			
			dataType = dat.nextByte();
			entryData = UEntryData.readBinary(dat, dataType);

			return true;
		}
		
		protected boolean readXMLNode_internal(Element xml_element) {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(xmlNodeName)) return false;
			
			String aval = null;
			aval = xml_element.getAttribute(XMLKEY_DATATYPE);
			if(aval != null) dataType = VpxyEntryType.valueFromString(aval);
			Element child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "UEntryData", "VarName", XMLKEY_ENTRYDATA);
			if(child != null) entryData = UEntryData.readXMLNode(child, dataType);

			return true;
		}
		
		public static AssetEntry readBinary(BufferReference dat) {
			if(dat == null) return null;
			AssetEntry str = new AssetEntry();
			if(!str.readBinary_internal(dat)) return null;
			return str;
		}
		
		public static AssetEntry readXMLNode(Element xml_element) {
			if(xml_element == null) return null;
			AssetEntry str = new AssetEntry();
			if(!str.readXMLNode_internal(xml_element)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getBinarySize() {
			int size = baseSize;
			size += entryData.getBinarySize();
			return size;
		}
		
		public FileBuffer writeBinary(boolean byteOrder) {
			FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
			writeBinaryTo(buff);
			return buff;
		}
		
		public int writeBinaryTo(FileBuffer target) {
			if(target == null) return 0;
			long stPos = target.getFileSize();
			
			target.addToFile(dataType);
			entryData.writeBinaryTo(target);

			return (int)(target.getFileSize() - stPos);
		}
	
		public void writeXMLNode(Writer out, String indent) throws IOException {
			writeXMLNode(out, indent, null);
		}
		
		public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";
			
			out.write(indent);
			out.write(String.format("<%s", xmlNodeName));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			out.write(String.format(" %s=\"%s\"", XMLKEY_DATATYPE, VpxyEntryType.stringFromValue(dataType)));
			out.write(">\n");
			entryData.writeXMLNode(out, indent + "\t", XMLKEY_ENTRYDATA);
			out.write(indent);
			out.write(String.format("</%s>\n", xmlNodeName));

		}
	
	}

	public static class UEntryData{

		private static final String XMLKEY_GROUPREFS = "GroupRefs";
		private static final String XMLKEY_SINGLEREF = "SingleRef";

		public byte dataType;
		
		//Only one of these
		public GroupRef groupRefs;
		public int singleRef;

		private String xmlNodeName;
		private int baseSize;
	
		public UEntryData(byte parentDataType) {
			xmlNodeName = "UEntryData";
			baseSize = 0;
			dataType = parentDataType;
		}
		
		/*----- Read -----*/
		
		protected boolean readBinary_internal(BufferReference dat) {
			if(dat == null) return false;
			
			if (dataType == VpxyEntryType.Group){
				groupRefs = GroupRef.readBinary(dat);
			}
			if (dataType == VpxyEntryType.Single){
				singleRef = dat.nextInt();
			}

			return true;
		}
		
		protected boolean readXMLNode_internal(Element xml_element) {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(xmlNodeName)) return false;
			
			String aval = null;
			Element child = null;
			if (dataType == VpxyEntryType.Group){
				child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "GroupRef", "VarName", XMLKEY_GROUPREFS);
				if(child != null) groupRefs = GroupRef.readXMLNode(child);
			}
			if (dataType == VpxyEntryType.Single){
				aval = xml_element.getAttribute(XMLKEY_SINGLEREF);
				if(aval != null) singleRef = StringUtils.parseSignedInt(aval);
			}

			return true;
		}
		
		public static UEntryData readBinary(BufferReference dat, byte parentType) {
			if(dat == null) return null;
			UEntryData str = new UEntryData(parentType);
			if(!str.readBinary_internal(dat)) return null;
			return str;
		}
		
		public static UEntryData readXMLNode(Element xml_element, byte parentType) {
			if(xml_element == null) return null;
			UEntryData str = new UEntryData(parentType);
			if(!str.readXMLNode_internal(xml_element)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getBinarySize() {
			int size = baseSize;
			if (dataType == VpxyEntryType.Group) size += groupRefs.getBinarySize();
			else size += 4;
			return size;
		}
		
		public FileBuffer writeBinary(boolean byteOrder) {
			FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
			writeBinaryTo(buff);
			return buff;
		}
		
		public int writeBinaryTo(FileBuffer target) {
			if(target == null) return 0;
			long stPos = target.getFileSize();
			
			if (dataType == VpxyEntryType.Group){
				groupRefs.writeBinaryTo(target);
			}
			if (dataType == VpxyEntryType.Single){
				target.addToFile(singleRef);
			}

			return (int)(target.getFileSize() - stPos);
		}
	
		public void writeXMLNode(Writer out, String indent) throws IOException {
			writeXMLNode(out, indent, null);
		}
		
		public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";
			
			out.write(indent);
			out.write(String.format("<%s", xmlNodeName));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			switch(dataType) {
			case VpxyEntryType.Single:
				out.write(String.format(" %s=\"%d\"/>\n", XMLKEY_SINGLEREF, singleRef));
				break;
			case VpxyEntryType.Group:
				out.write(">\n");
				groupRefs.writeXMLNode(out, indent + "\t", XMLKEY_GROUPREFS);
				out.write(indent);
				out.write(String.format("</%s>\n", xmlNodeName));
				break;
			}
		}
	
	}
	
	public static class GroupRef{

		private static final String XMLKEY_MSINDEX = "MsIndex";
		//private static final String XMLKEY_REFCOUNT = "RefCount";
		private static final String XMLKEY_REFLIST = "RefList";

		public byte msIndex;
		public byte refCount;
		public int[] refList;

		private String xmlNodeName;
		private int baseSize;
	
		public GroupRef() {
			xmlNodeName = "GroupRef";
			baseSize = 2;
		}
		
		/*----- Read -----*/
		
		protected boolean readBinary_internal(BufferReference dat) {
			if(dat == null) return false;
			msIndex = dat.nextByte();
			refCount = dat.nextByte();
			if(refCount > 0) {
				refList = new int[refCount];
				for(int i = 0; i < refCount; i++){
					refList[i] = dat.nextInt();
				}	
			}
			else refList = null;
			return true;
		}
		
		protected boolean readXMLNode_internal(Element xml_element) {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(xmlNodeName)) return false;
			
			String aval = null;
			Element child = null;
			aval = xml_element.getAttribute(XMLKEY_MSINDEX);
			if(aval != null) msIndex = (byte)StringUtils.parseUnsignedInt(aval);
			//aval = xml_element.getAttribute(XMLKEY_REFCOUNT);
			//if(aval != null) refCount = (byte)StringUtils.parseUnsignedInt(aval);
			child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "Array", "VarName", XMLKEY_REFLIST);
			if((child != null) && (refCount > 0)){
				List<Element> gclist = XMLReader.getChildElementsWithTag(child, "ArrayMember");
				int i = 0;
				refCount = (byte)gclist.size();
				if(refCount > 0) {
					refList = new int[refCount];
					for(Element gc : gclist){
						aval = gc.getAttribute("Value");
						if(aval != null) refList[i] = StringUtils.parseSignedInt(aval);
						i++;
					}	
				}
			}

			return true;
		}
		
		public static GroupRef readBinary(BufferReference dat) {
			if(dat == null) return null;
			GroupRef str = new GroupRef();
			if(!str.readBinary_internal(dat)) return null;
			return str;
		}
		
		public static GroupRef readXMLNode(Element xml_element) {
			if(xml_element == null) return null;
			GroupRef str = new GroupRef();
			if(!str.readXMLNode_internal(xml_element)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getBinarySize() {
			int size = baseSize;
			if(refList != null) size += (refList.length << 2);
			return size;
		}
		
		public FileBuffer writeBinary(boolean byteOrder) {
			FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
			writeBinaryTo(buff);
			return buff;
		}
		
		public int writeBinaryTo(FileBuffer target) {
			if(target == null) return 0;
			long stPos = target.getFileSize();
			
			if(refList != null) refCount = (byte)refList.length;
			else refCount = 0;
			target.addToFile(msIndex);
			target.addToFile(refCount);
			for(int i = 0; i < refCount; i++){
				target.addToFile(refList[i]);
			}

			return (int)(target.getFileSize() - stPos);
		}
	
		public void writeXMLNode(Writer out, String indent) throws IOException {
			writeXMLNode(out, indent, null);
		}
		
		public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";
			
			if(refList != null) refCount = (byte)refList.length;
			else refCount = 0;
			out.write(indent);
			out.write(String.format("<%s", xmlNodeName));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			out.write(String.format(" %s=\"0x%02x\"", XMLKEY_MSINDEX, msIndex));
			//out.write(String.format(" %s=\"0x%02x\"", XMLKEY_REFCOUNT, refCount));
			out.write(">\n");
			out.write(indent + String.format("\t<Array VarName=\"%s\">\n", XMLKEY_REFLIST));
			for(int i = 0; i < refCount; i++){
				out.write(indent + String.format("\t\t<ArrayMember Value=\"%d\"/>\n", refList[i]));
			}
			out.write(indent + "\t</Array>\n");
			out.write(indent);
			out.write(String.format("</%s>\n", xmlNodeName));

		}
	
	}

	/*----- Read -----*/
	
	protected boolean readBinary_internal(BufferReference dat) {
		if(dat == null) return false;
		
		magicNo = new byte[4];
		for(int i = 0; i < 4; i++){
			magicNo[i] = dat.nextByte();
		}
		fileVersion = dat.nextInt();
		tgiOffset = dat.nextInt();
		tgiTableSize = dat.nextInt();
		entryCount = dat.nextByte();
		assetEntries.ensureCapacity(entryCount);
		for(int i = 0; i < entryCount; i++){
			AssetEntry assetEntry = AssetEntry.readBinary(dat);
			if(assetEntry != null) assetEntries.add(assetEntry);
		}
		bbType = dat.nextByte();
		boundingBox = new float[6];
		for(int i = 0; i < 6; i++){
			boundingBox[i] = Float.intBitsToFloat(dat.nextInt());
		}
		unkA = new byte[4];
		for(int i = 0; i < 4; i++){
			unkA[i] = dat.nextByte();
		}
		hasFootprint = MaxisTypes.readBinaryBool(dat);
		if (hasFootprint) ftptRefIndex = dat.nextInt();
		tgiCount = dat.nextByte();
		tgiTable.ensureCapacity(tgiCount);
		for(int i = 0; i < tgiCount; i++){
			MaxisResKey resKey = MaxisResKey.readBinTGI(dat);
			if(resKey != null) tgiTable.add(resKey);
		}

		return true;
	}
	
	protected boolean readXMLNode_internal(Element xml_element) {
		if(xml_element == null) return false;
		String nn = xml_element.getNodeName();
		if(nn == null) return false;
		if(!nn.equals(xmlNodeName)) return false;
		
		String aval = null;
		Element child = null;
		child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "Array", "VarName", XMLKEY_MAGICNO);
		if(child != null){
			magicNo = new byte[4];
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "ArrayMember");
			int i = 0;
			for(Element gc : gclist){
				aval = gc.getAttribute("Value");
				if(aval != null) magicNo[i] = (byte)StringUtils.parseUnsignedInt(aval);
				i++;
			}
		}
		aval = xml_element.getAttribute(XMLKEY_FILEVERSION);
		if(aval != null) fileVersion = StringUtils.parseUnsignedInt(aval);
		aval = xml_element.getAttribute(XMLKEY_TGIOFFSET);
		if(aval != null) tgiOffset = StringUtils.parseUnsignedInt(aval);
		aval = xml_element.getAttribute(XMLKEY_TGITABLESIZE);
		if(aval != null) tgiTableSize = StringUtils.parseUnsignedInt(aval);
		aval = xml_element.getAttribute(XMLKEY_ENTRYCOUNT);
		if(aval != null) entryCount = (byte)StringUtils.parseUnsignedInt(aval);
		child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "List", "VarName", XMLKEY_ASSETENTRIES);
		if(child != null){
			assetEntries.ensureCapacity(entryCount);
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "AssetEntry");
			for(Element gc : gclist){
				assetEntries.add(AssetEntry.readXMLNode(gc));
			}
		}
		aval = xml_element.getAttribute(XMLKEY_BBTYPE);
		if(aval != null) bbType = (byte)StringUtils.parseUnsignedInt(aval);
		child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "Array", "VarName", XMLKEY_BOUNDINGBOX);
		if(child != null){
			boundingBox = new float[6];
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "ArrayMember");
			int i = 0;
			for(Element gc : gclist){
				aval = gc.getAttribute("Value");
				if(aval != null) boundingBox[i] = (float)Double.parseDouble(aval);
				i++;
			}
		}
		child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "Array", "VarName", XMLKEY_UNKA);
		if(child != null){
			unkA = new byte[4];
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "ArrayMember");
			int i = 0;
			for(Element gc : gclist){
				aval = gc.getAttribute("Value");
				if(aval != null) unkA[i] = (byte)StringUtils.parseUnsignedInt(aval);
				i++;
			}
		}
		aval = xml_element.getAttribute(XMLKEY_HASFOOTPRINT);
		if(aval != null) hasFootprint = Boolean.parseBoolean(aval);
		if (hasFootprint){
			aval = xml_element.getAttribute(XMLKEY_FTPTREFINDEX);
			if(aval != null) ftptRefIndex = StringUtils.parseSignedInt(aval);
		}
		aval = xml_element.getAttribute(XMLKEY_TGICOUNT);
		if(aval != null) tgiCount = (byte)StringUtils.parseUnsignedInt(aval);
		child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "List", "VarName", XMLKEY_TGITABLE);
		if(child != null){
			tgiTable.ensureCapacity(tgiCount);
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "MaxisResKey");
			for(Element gc : gclist){
				tgiTable.add(MaxisResKey.readXMLNode(gc));
			}
		}

		return true;
	}
	
	public static VisualProxy readBinary(BufferReference dat) {
		if(dat == null) return null;
		VisualProxy str = new VisualProxy();
		if(!str.readBinary_internal(dat)) return null;
		return str;
	}
	
	public static VisualProxy readXMLNode(Element xml_element) {
		if(xml_element == null) return null;
		VisualProxy str = new VisualProxy();
		if(!str.readXMLNode_internal(xml_element)) return null;
		return str;
	}
	
	/*----- Write -----*/
	
	public int getBinarySize() {
		int size = baseSize;
		size += magicNo.length;
		for(AssetEntry assetEntries : assetEntries){
			size += assetEntries.getBinarySize();
		}
		size += (boundingBox.length * 4);
		size += unkA.length;
		size += tgiTable.size() << 4;
		return size;
	}
	
	public FileBuffer writeBinary(boolean byteOrder) {
		FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
		writeBinaryTo(buff);
		return buff;
	}
	
	public int writeBinaryTo(FileBuffer target) {
		if(target == null) return 0;
		long stPos = target.getFileSize();
		
		entryCount = (byte)assetEntries.size();
		tgiCount = (byte)tgiTable.size();
		for(int i = 0; i < 4; i++){
			target.addToFile(magicNo[i]);
		}
		target.addToFile(fileVersion);
		target.addToFile(tgiOffset);
		target.addToFile(tgiTableSize);
		target.addToFile(entryCount);
		for(AssetEntry assetEntries : assetEntries){
			assetEntries.writeBinaryTo(target);
		}
		target.addToFile(bbType);
		for(int i = 0; i < 6; i++){
			target.addToFile(Float.floatToRawIntBits(boundingBox[i]));
		}
		for(int i = 0; i < 4; i++){
			target.addToFile(unkA[i]);
		}
		MaxisTypes.writeBinaryBool(target, hasFootprint);
		if (hasFootprint){
			target.addToFile(ftptRefIndex);
		}
		target.addToFile(tgiCount);
		for(MaxisResKey resKey : tgiTable){
			resKey.writeBinTGI(target);
		}

		return (int)(target.getFileSize() - stPos);
	}

	public void writeXMLNode(Writer out, String indent) throws IOException {
		writeXMLNode(out, indent, null);
	}
	
	public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
		if(out == null) return;
		if(indent == null) indent = "";
		
		entryCount = (byte)assetEntries.size();
		tgiCount = (byte)tgiTable.size();
		out.write(indent);
		out.write(String.format("<%s", xmlNodeName));
		if(varName != null){
			out.write(String.format(" VarName=\"%s\"", varName));
		}
		out.write(String.format(" %s=\"0x%08x\"", XMLKEY_FILEVERSION, fileVersion));
		out.write(String.format(" %s=\"0x%08x\"", XMLKEY_TGIOFFSET, tgiOffset));
		out.write(String.format(" %s=\"0x%08x\"", XMLKEY_TGITABLESIZE, tgiTableSize));
		out.write(String.format(" %s=\"0x%02x\"", XMLKEY_ENTRYCOUNT, entryCount));
		out.write(String.format(" %s=\"0x%02x\"", XMLKEY_BBTYPE, bbType));
		out.write(String.format(" %s=\"%b\"", XMLKEY_HASFOOTPRINT, hasFootprint));
		if (hasFootprint){
			out.write(String.format(" %s=\"%d\"", XMLKEY_FTPTREFINDEX, ftptRefIndex));
		}
		out.write(String.format(" %s=\"0x%02x\"", XMLKEY_TGICOUNT, tgiCount));
		out.write(">\n");
		out.write(indent + String.format("\t<Array VarName=\"%s\">\n", XMLKEY_MAGICNO));
		for(int i = 0; i < 4; i++){
			out.write(indent + String.format("\t\t<ArrayMember Value=\"%c\"/>\n", magicNo[i]));
		}
		out.write(indent + "\t</Array>\n");
		out.write(indent + "\t<List ");
		out.write(String.format(" VarName=\"%s\">\n", XMLKEY_ASSETENTRIES));
		for(AssetEntry assetEntries : assetEntries){
			assetEntries.writeXMLNode(out, indent + "\t\t", null);
		}
		out.write(indent + "\t</List>\n");
		out.write(indent + String.format("\t<Array VarName=\"%s\">\n", XMLKEY_BOUNDINGBOX));
		for(int i = 0; i < 6; i++){
			out.write(indent + String.format("\t\t<ArrayMember Value=\"%.3f\"/>\n", boundingBox[i]));
		}
		out.write(indent + "\t</Array>\n");
		out.write(indent + String.format("\t<Array VarName=\"%s\">\n", XMLKEY_UNKA));
		for(int i = 0; i < 4; i++){
			out.write(indent + String.format("\t\t<ArrayMember Value=\"0x%02x\"/>\n", unkA[i]));
		}
		out.write(indent + "\t</Array>\n");
		out.write(indent + "\t<List ");
		out.write(String.format(" VarName=\"%s\">\n", XMLKEY_TGITABLE));
		for(MaxisResKey resKey : tgiTable){
			resKey.writeXMLNode(out, indent + "\t\t");
		}
		out.write(indent + "\t</List>\n");
		out.write(indent);
		out.write(String.format("</%s>\n", xmlNodeName));

	}

}
