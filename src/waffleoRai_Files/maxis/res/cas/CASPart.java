/*-----------------------------------------------------
 * Autogenerated Java class from XML definition.
 * Created Sun, 26 Jan 2025 15:05:58 -0600
 *-----------------------------------------------------*/

package waffleoRai_Files.maxis.res.cas;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Writer;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import waffleoRai_Containers.maxis.MaxisResKey;
import waffleoRai_Containers.maxis.MaxisTypes;
import waffleoRai_Files.XMLReader;
import waffleoRai_Files.maxis.MaxisResRef;
import waffleoRai_Files.maxis.res.XMLInteriorFile;
import waffleoRai_Files.maxis.res.gfx.TextureCompositor;
import waffleoRai_Files.maxis.ts3enum.CASAgeGenderFlags;
import waffleoRai_Files.maxis.ts3enum.OutfitCategories;
import waffleoRai_Files.maxis.ts3enum.cas.CASGeomFlags;
import waffleoRai_Files.maxis.ts3enum.cas.CASPartType;
import waffleoRai_Files.maxis.ts3enum.cas.ClothingType;
import waffleoRai_Utils.BufferReference;
import waffleoRai_Utils.FileBuffer;
import waffleoRai_Utils.FileUtils;
import waffleoRai_Utils.StringUtils;

public class CASPart{ 
	
	public static final String XML_NODE_NAME = "CASPart";
	private static final int BASE_BIN_SIZE = 57;
	
	public static final int DEFO_FILE_WRITE_VERSION = 18;

	private static final String XMLKEY_XMLPRESETS = "XmlPresets";
	private static final String XMLKEY_PARTNAME = "PartName";
	private static final String XMLKEY_SORTPRIORITY = "SortPriority";
	private static final String XMLKEY_UNKA = "UnkA";
	private static final String XMLKEY_CLOTHINGTYPE = "ClothingType";
	private static final String XMLKEY_PARTFLAGS = "PartFlags";
	private static final String XMLKEY_AGEGENDERFLAGS = "AgeGenderFlags";
	private static final String XMLKEY_CATEGORY = "Category";
	private static final String XMLKEY_NAKEDREFINDEX = "NakedRefIndex";
	private static final String XMLKEY_PARENTREFINDEX = "ParentRefIndex";
	private static final String XMLKEY_FATBLENDREFINDEX = "FatBlendRefIndex";
	private static final String XMLKEY_FITBLENDREFINDEX = "FitBlendRefIndex";
	private static final String XMLKEY_THINBLENDREFINDEX = "ThinBlendRefIndex";
	private static final String XMLKEY_SPECIALBLENDREFINDEX = "SpecialBlendRefIndex";
	private static final String XMLKEY_UNKB = "UnkB";
	private static final String XMLKEY_VPXYLIST = "VpxyList";
	private static final String XMLKEY_LODLIST = "LodList";
	private static final String XMLKEY_DIFFUSETXTCALIST = "DiffuseTxtcAList";
	private static final String XMLKEY_SPECULARTXTCALIST = "SpecularTxtcAList";
	private static final String XMLKEY_DIFFUSETXTCBLIST = "DiffuseTxtcBList";
	private static final String XMLKEY_SPECULARTXTCBLIST = "SpecularTxtcBList";
	private static final String XMLKEY_BONEDELTALIST = "BoneDeltaList";
	private static final String XMLKEY_SHOEMATERIAL = "ShoeMaterial";
	private static final String XMLKEY_TGITABLE = "TgiTable";
	
	private static final String XMLKEY_COMMON_REFS = "CommonRefs";
	private static final String XMLKEY_REF_GEN = "ResourceRef";

	public ArrayList<XmlPreset> xmlPresets = new ArrayList<XmlPreset>();
	public String partName;
	public float sortPriority;
	public byte unkA;
	public int clothingType;
	public int partFlags;
	public int ageGenderFlags;
	public int category;
	public byte nakedRefIndex;
	public byte parentRefIndex;
	public byte fatBlendRefIndex;
	public byte fitBlendRefIndex;
	public byte thinBlendRefIndex;
	public byte specialBlendRefIndex;
	public int unkB;
	public ArrayList<Integer> vpxyList = new ArrayList<Integer>();
	public ArrayList<CASLodInfo> lodList = new ArrayList<CASLodInfo>();
	public ArrayList<Integer> diffuseTxtcAList = new ArrayList<Integer>();
	public ArrayList<Integer> specularTxtcAList = new ArrayList<Integer>();
	public ArrayList<Integer> diffuseTxtcBList = new ArrayList<Integer>();
	public ArrayList<Integer> specularTxtcBList = new ArrayList<Integer>();
	public ArrayList<Integer> boneDeltaList = new ArrayList<Integer>();
	public String shoeMaterial;
	public ArrayList<MaxisResRef> tgiTable = new ArrayList<MaxisResRef>();

	/*----- Inner Classes -----*/

	public static class XmlPreset{
		
		public static final String XML_NODE_NAME = "XmlPreset";
		private static final int BASE_BIN_SIZE = 8;

		private static final String XMLKEY_PRESETXML = "PresetXml";
		private static final String XMLKEY_UNK_XMLPRESET = "Unk_xmlpreset";

		public int charCount;
		public XMLInteriorFile presetXml;
		public int unk_xmlpreset;
		
		/*----- Read -----*/
		
		protected boolean readBinary_internal(BufferReference dat) {
			if(dat == null) return false;
			
			charCount = dat.nextInt();
			presetXml = XMLInteriorFile.readBinary(dat, charCount);
			unk_xmlpreset = dat.nextInt();

			return true;
		}
		
		protected boolean readXMLNode_internal(Element xml_element, String wd) throws IOException {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(XML_NODE_NAME)) return false;
			
			String aval = null;
			aval = xml_element.getAttribute(XMLKEY_PRESETXML);
			if((aval != null) && !aval.isEmpty()) {
				String absPath = FileUtils.unixRelPath2Local(wd, aval);
				presetXml = XMLInteriorFile.importFile(absPath);
			}
				
			aval = xml_element.getAttribute(XMLKEY_UNK_XMLPRESET);
			if((aval != null) && !aval.isEmpty()) unk_xmlpreset = StringUtils.parseUnsignedInt(aval);

			return true;
		}
		
		public static XmlPreset readBinary(BufferReference dat) {
			if(dat == null) return null;
			XmlPreset str = new XmlPreset();
			if(!str.readBinary_internal(dat)) return null;
			return str;
		}
		
		public static XmlPreset readXMLNode(Element xml_element, String wd) throws IOException {
			if(xml_element == null) return null;
			XmlPreset str = new XmlPreset();
			if(!str.readXMLNode_internal(xml_element, wd)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getBinarySize() {
			int size = BASE_BIN_SIZE;
			size += presetXml.getBinarySize();
			return size;
		}
		
		public FileBuffer writeBinary(boolean byteOrder) {
			FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
			writeBinaryTo(buff);
			return buff;
		}
		
		public int writeBinaryTo(FileBuffer target) {
			if(target == null) return 0;
			long stPos = target.getFileSize();
			
			charCount = presetXml.getCharCount();
			target.addToFile(charCount);
			presetXml.writeBinaryTo(target);
			target.addToFile(unk_xmlpreset);

			return (int)(target.getFileSize() - stPos);
		}
	
		public void writeXMLNode(Writer out, String indent, String wd, String xmlExpPath) throws IOException {
			writeXMLNode(out, indent, null, wd, xmlExpPath);
		}
		
		public void writeXMLNode(Writer out, String indent, String varName, String wd, String xmlExpPath) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";

			out.write(indent);
			out.write(String.format("<%s", XML_NODE_NAME));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			if(presetXml != null) {
				String expPathRel = FileUtils.localPath2UnixRel(wd, xmlExpPath);
				out.write(String.format(" %s=\"%s\"", XMLKEY_PRESETXML, expPathRel));
				presetXml.exportFile(xmlExpPath);
			}
			out.write("/>\n");
		}

	}

	public static class CASLodInfo{
		
		public static final String XML_NODE_NAME = "CASLodInfo";
		private static final int BASE_BIN_SIZE = 6;

		private static final String XMLKEY_LEVEL = "Level";
		private static final String XMLKEY_DESTTEXTURE = "DestTexture";
		//private static final String XMLKEY_ASSETCOUNT = "AssetCount";
		private static final String XMLKEY_LODASSETLIST = "LodAssetList";

		public byte level;
		public int destTexture;
		public ArrayList<CASLodAsset> lodAssetList = new ArrayList<CASLodAsset>();

		/*----- Read -----*/
		
		protected boolean readBinary_internal(BufferReference dat) {
			if(dat == null) return false;
			
			level = dat.nextByte();
			destTexture = dat.nextInt();
			int assetCount = Byte.toUnsignedInt(dat.nextByte());
			lodAssetList.ensureCapacity(assetCount);
			for(int i = 0; i < assetCount; i++){
				CASLodAsset lodAsset = CASLodAsset.readBinary(dat);
				if(lodAsset != null) lodAssetList.add(lodAsset);
			}

			return true;
		}
		
		protected boolean readXMLNode_internal(Element xml_element) {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(XML_NODE_NAME)) return false;
			
			String aval = null;
			Element child = null;
			aval = xml_element.getAttribute(XMLKEY_LEVEL);
			if(aval != null) level = (byte)StringUtils.parseUnsignedInt(aval);
			aval = xml_element.getAttribute(XMLKEY_DESTTEXTURE);
			if(aval != null) destTexture = CASPartType.valueFromString(aval);
			//aval = xml_element.getAttribute(XMLKEY_ASSETCOUNT);
			//if(aval != null) assetCount = (byte)StringUtils.parseUnsignedInt(aval);
			child = XMLReader.getFirstChildElementWithTagAndAttribute(xml_element, "List", "VarName", XMLKEY_LODASSETLIST);
			if(child != null){
				List<Element> gclist = XMLReader.getChildElementsWithTag(child, CASLodAsset.XML_NODE_NAME);
				int assetCount = gclist.size();
				if(assetCount > 0) {
					lodAssetList.ensureCapacity(assetCount);
					for(Element gc : gclist){
						lodAssetList.add(CASLodAsset.readXMLNode(gc));
					}
				}
			}

			return true;
		}
		
		public static CASLodInfo readBinary(BufferReference dat) {
			if(dat == null) return null;
			CASLodInfo str = new CASLodInfo();
			if(!str.readBinary_internal(dat)) return null;
			return str;
		}
		
		public static CASLodInfo readXMLNode(Element xml_element) {
			if(xml_element == null) return null;
			CASLodInfo str = new CASLodInfo();
			if(!str.readXMLNode_internal(xml_element)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getBinarySize() {
			int size = BASE_BIN_SIZE;
			for(CASLodAsset lodAssetList : lodAssetList){
				size += lodAssetList.getBinarySize();
			}
			return size;
		}
		
		public FileBuffer writeBinary(boolean byteOrder) {
			FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
			writeBinaryTo(buff);
			return buff;
		}
		
		public int writeBinaryTo(FileBuffer target) {
			if(target == null) return 0;
			long stPos = target.getFileSize();
			
			int assetCount = lodAssetList.size();
			target.addToFile(level);
			target.addToFile(destTexture);
			target.addToFile(assetCount);
			for(CASLodAsset lodAssetList : lodAssetList){
				lodAssetList.writeBinaryTo(target);
			}

			return (int)(target.getFileSize() - stPos);
		}
	
		public void writeXMLNode(Writer out, String indent) throws IOException {
			writeXMLNode(out, indent, null);
		}
		
		public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";
			
			out.write(indent);
			out.write(String.format("<%s", XML_NODE_NAME));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			out.write(String.format(" %s=\"0x%02x\"", XMLKEY_LEVEL, level));
			out.write(String.format(" %s=\"%s\"", XMLKEY_DESTTEXTURE, CASPartType.stringFromValue(destTexture)));
			out.write(">\n");
			out.write(indent + "\t<List");
			out.write(String.format(" VarName=\"%s\">\n", XMLKEY_LODASSETLIST));
			for(CASLodAsset lodAssetList : lodAssetList){
				lodAssetList.writeXMLNode(out, indent + "\t\t", null);
			}
			out.write(indent + "\t</List>\n");
			out.write(indent);
			out.write(String.format("</%s>\n", XML_NODE_NAME));
		}
	
	}

	public static class CASLodAsset{
		
		public static final String XML_NODE_NAME = "CASLodAsset";
		private static final int BASE_BIN_SIZE = 12;

		private static final String XMLKEY_SORTING = "Sorting";
		private static final String XMLKEY_SPECLEVEL = "SpecLevel";
		private static final String XMLKEY_CASTSHADOW = "CastShadow";

		public int sorting;
		public int specLevel;
		public int castShadow;
	
		/*----- Read -----*/
		
		protected boolean readBinary_internal(BufferReference dat) {
			if(dat == null) return false;
			
			sorting = dat.nextInt();
			specLevel = dat.nextInt();
			castShadow = dat.nextInt();

			return true;
		}
		
		protected boolean readXMLNode_internal(Element xml_element) {
			if(xml_element == null) return false;
			String nn = xml_element.getNodeName();
			if(nn == null) return false;
			if(!nn.equals(XML_NODE_NAME)) return false;
			
			String aval = null;
			aval = xml_element.getAttribute(XMLKEY_SORTING);
			if(aval != null) sorting = CASGeomFlags.valueFromString(aval);
			aval = xml_element.getAttribute(XMLKEY_SPECLEVEL);
			if(aval != null) specLevel = CASGeomFlags.valueFromString(aval);
			aval = xml_element.getAttribute(XMLKEY_CASTSHADOW);
			if(aval != null) castShadow = CASGeomFlags.valueFromString(aval);

			return true;
		}
		
		public static CASLodAsset readBinary(BufferReference dat) {
			if(dat == null) return null;
			CASLodAsset str = new CASLodAsset();
			if(!str.readBinary_internal(dat)) return null;
			return str;
		}
		
		public static CASLodAsset readXMLNode(Element xml_element) {
			if(xml_element == null) return null;
			CASLodAsset str = new CASLodAsset();
			if(!str.readXMLNode_internal(xml_element)) return null;
			return str;
		}
		
		/*----- Write -----*/
		
		public int getBinarySize() {return BASE_BIN_SIZE;}
		
		public FileBuffer writeBinary(boolean byteOrder) {
			FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
			writeBinaryTo(buff);
			return buff;
		}
		
		public int writeBinaryTo(FileBuffer target) {
			if(target == null) return 0;
			long stPos = target.getFileSize();
			
			target.addToFile(sorting);
			target.addToFile(specLevel);
			target.addToFile(castShadow);

			return (int)(target.getFileSize() - stPos);
		}
	
		public void writeXMLNode(Writer out, String indent) throws IOException {
			writeXMLNode(out, indent, null);
		}
		
		public void writeXMLNode(Writer out, String indent, String varName) throws IOException {
			if(out == null) return;
			if(indent == null) indent = "";
			
			out.write(indent);
			out.write(String.format("<%s", XML_NODE_NAME));
			if(varName != null){
				out.write(String.format(" VarName=\"%s\"", varName));
			}
			out.write(String.format(" %s=\"%s\"", XMLKEY_SORTING, CASGeomFlags.stringFromValue(sorting)));
			out.write(String.format(" %s=\"%s\"", XMLKEY_SPECLEVEL, CASGeomFlags.stringFromValue(specLevel)));
			out.write(String.format(" %s=\"%s\"", XMLKEY_CASTSHADOW, CASGeomFlags.stringFromValue(castShadow)));
			out.write("/>\n");
		}
	
	}

	/*----- Read -----*/
	
	private static int resolveRefIndex(String attrString, Map<String, Integer> refIndexMap) {
		if(attrString == null) return -1;
		if(attrString.isEmpty()) return -1;
		int myval = -1;
		Integer n = refIndexMap.get(attrString);
		if(n != null) myval = (byte)((int)n);
		else myval = (byte)StringUtils.parseUnsignedInt(attrString);
		return myval;
	}
	
	protected boolean readBinary_internal(BufferReference dat) {
		if(dat == null) return false;
		
		int fileVersion = dat.nextInt();
		int tgiOffset = dat.nextInt();
		int presetCount = dat.nextInt();
		xmlPresets.ensureCapacity(presetCount);
		for(int i = 0; i < presetCount; i++){
			XmlPreset xmlPreset = XmlPreset.readBinary(dat);
			if(xmlPreset != null) xmlPresets.add(xmlPreset);
		}
		partName = MaxisTypes.readMaxis7String(dat);
		sortPriority = Float.intBitsToFloat(dat.nextInt());
		unkA = dat.nextByte();
		clothingType = dat.nextInt();
		partFlags = dat.nextInt();
		ageGenderFlags = dat.nextInt();
		category = dat.nextInt();
		nakedRefIndex = dat.nextByte();
		parentRefIndex = dat.nextByte();
		fatBlendRefIndex = dat.nextByte();
		fitBlendRefIndex = dat.nextByte();
		thinBlendRefIndex = dat.nextByte();
		specialBlendRefIndex = dat.nextByte();
		unkB = dat.nextInt();
		int vpxyCount = Byte.toUnsignedInt(dat.nextByte());
		vpxyList.ensureCapacity(vpxyCount);
		for(int i = 0; i < vpxyCount; i++){
			int vpxyRefIndex = Byte.toUnsignedInt(dat.nextByte());
			vpxyList.add(vpxyRefIndex);
		}
		int lodCount = Byte.toUnsignedInt(dat.nextByte());
		lodList.ensureCapacity(lodCount);
		for(int i = 0; i < lodCount; i++){
			CASLodInfo lod = CASLodInfo.readBinary(dat);
			if(lod != null) lodList.add(lod);
		}
		int diffuseTxtcACount = Byte.toUnsignedInt(dat.nextByte());
		diffuseTxtcAList.ensureCapacity(diffuseTxtcACount);
		for(int i = 0; i < diffuseTxtcACount; i++){
			int refIndex = Byte.toUnsignedInt(dat.nextByte());
			diffuseTxtcAList.add(refIndex);
		}
		int specularTxtcACount = Byte.toUnsignedInt(dat.nextByte());
		specularTxtcAList.ensureCapacity(specularTxtcACount);
		for(int i = 0; i < specularTxtcACount; i++){
			int refIndex = Byte.toUnsignedInt(dat.nextByte());
			specularTxtcAList.add(refIndex);
		}
		int diffuseTxtcBCount = Byte.toUnsignedInt(dat.nextByte());
		diffuseTxtcBList.ensureCapacity(diffuseTxtcBCount);
		for(int i = 0; i < diffuseTxtcBCount; i++){
			int refIndex = Byte.toUnsignedInt(dat.nextByte());
			diffuseTxtcBList.add(refIndex);
		}
		int specularTxtcBCount = Byte.toUnsignedInt(dat.nextByte());
		specularTxtcBList.ensureCapacity(specularTxtcBCount);
		for(int i = 0; i < specularTxtcBCount; i++){
			int refIndex = Byte.toUnsignedInt(dat.nextByte());
			specularTxtcBList.add(refIndex);
		}
		int boneDeltaCount = Byte.toUnsignedInt(dat.nextByte());
		boneDeltaList.ensureCapacity(boneDeltaCount);
		for(int i = 0; i < boneDeltaCount; i++){
			int refIndex = Byte.toUnsignedInt(dat.nextByte());
			boneDeltaList.add(refIndex);
		}
		shoeMaterial = MaxisTypes.readMaxis7String(dat);
		int tgiCount = Byte.toUnsignedInt(dat.nextByte());
		tgiTable.ensureCapacity(tgiCount);
		for(int i = 0; i < tgiCount; i++){
			MaxisResKey resKey = MaxisResKey.readBinIGT(dat);
			if(resKey != null) tgiTable.add(new MaxisResRef(resKey));
		}

		return true;
	}
	
	protected boolean readXMLNode_internal(Element xml_element, String wd) throws IOException {
		if(xml_element == null) return false;
		String nn = xml_element.getNodeName();
		if(nn == null) return false;
		if(!nn.equals(XML_NODE_NAME)) return false;
		
		String aval = null;
		Element child = null;
		
		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_TGITABLE);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "MaxisResReference");
			int tgiCount = gclist.size();
			if(tgiCount > 0) {
				tgiTable.ensureCapacity(tgiCount);
				for(Element gc : gclist){
					tgiTable.add(MaxisResRef.fromXMLNode(gc));
				}	
			}
		}
		
		Map<String, Integer> refIndexMap = new HashMap<String, Integer>();
		int i = 0;
		if(!tgiTable.isEmpty()) {
			for(MaxisResRef ref : tgiTable) {
				String u = ref.getUniqueName();
				if(u != null) {
					refIndexMap.put(u, i);
				}
				MaxisResKey key = ref.getKey();
				refIndexMap.put(key.genXMLValue(), i);
				i++;
			}	
		}
		
		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_XMLPRESETS);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "XmlPreset");
			int xmlPresetCount = gclist.size();
			if(xmlPresetCount > 0) {
				xmlPresets.ensureCapacity(xmlPresetCount);
				for(Element gc : gclist){
					xmlPresets.add(XmlPreset.readXMLNode(gc, wd));
				}	
			}
		}
		
		aval = xml_element.getAttribute(XMLKEY_PARTNAME);
		if((aval != null) && (!aval.isEmpty())) partName = aval;
		aval = xml_element.getAttribute(XMLKEY_SORTPRIORITY);
		if((aval != null) && (!aval.isEmpty())) sortPriority = (float)Double.parseDouble(aval);
		aval = xml_element.getAttribute(XMLKEY_UNKA);
		if((aval != null) && (!aval.isEmpty())) unkA = (byte)StringUtils.parseUnsignedInt(aval);
		aval = xml_element.getAttribute(XMLKEY_CLOTHINGTYPE);
		if((aval != null) && (!aval.isEmpty())) clothingType = ClothingType.valueFromString(aval);
		aval = xml_element.getAttribute(XMLKEY_PARTFLAGS);
		if((aval != null) && (!aval.isEmpty())) partFlags = CASPartType.valueFromString(aval);
		aval = xml_element.getAttribute(XMLKEY_AGEGENDERFLAGS);
		if((aval != null) && (!aval.isEmpty())) ageGenderFlags = CASAgeGenderFlags.valueFromString(aval);
		aval = xml_element.getAttribute(XMLKEY_CATEGORY);
		if((aval != null) && (!aval.isEmpty())) category = OutfitCategories.valueFromString(aval);
		aval = xml_element.getAttribute(XMLKEY_UNKB);
		if((aval != null) && (!aval.isEmpty())) unkB = StringUtils.parseUnsignedInt(aval);
		
		//Resolve some references
		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_COMMON_REFS);
		if(child != null) {
			aval = child.getAttribute(XMLKEY_NAKEDREFINDEX);
			nakedRefIndex = (byte)resolveRefIndex(aval, refIndexMap);
			aval = child.getAttribute(XMLKEY_PARENTREFINDEX);
			parentRefIndex = (byte)resolveRefIndex(aval, refIndexMap);
			aval = child.getAttribute(XMLKEY_FATBLENDREFINDEX);
			fatBlendRefIndex = (byte)resolveRefIndex(aval, refIndexMap);
			aval = child.getAttribute(XMLKEY_FITBLENDREFINDEX);
			fitBlendRefIndex = (byte)resolveRefIndex(aval, refIndexMap);
			aval = child.getAttribute(XMLKEY_THINBLENDREFINDEX);
			thinBlendRefIndex = (byte)resolveRefIndex(aval, refIndexMap);
			aval = child.getAttribute(XMLKEY_SPECIALBLENDREFINDEX);
			specialBlendRefIndex = (byte)resolveRefIndex(aval, refIndexMap);	
		}
		
		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_VPXYLIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, XMLKEY_REF_GEN);
			int vpxyCount = gclist.size();
			if(vpxyCount > 0) {
				vpxyList.ensureCapacity(vpxyCount);
				for(Element gc : gclist){
					aval = gc.getAttribute("Value");
					int val = resolveRefIndex(aval, refIndexMap);
					vpxyList.add(val);
				}
			}
		}

		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_LODLIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, "CASLodInfo");
			int lodCount = gclist.size();
			if(lodCount > 0) {
				lodList.ensureCapacity(lodCount);
				for(Element gc : gclist){
					lodList.add(CASLodInfo.readXMLNode(gc));
				}	
			}
		}

		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_DIFFUSETXTCALIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, XMLKEY_REF_GEN);
			int diffuseTxtcACount = gclist.size();
			if(diffuseTxtcACount > 0) {
				diffuseTxtcAList.ensureCapacity(diffuseTxtcACount);
				for(Element gc : gclist){
					aval = gc.getAttribute("Value");
					int val = resolveRefIndex(aval, refIndexMap);
					diffuseTxtcAList.add(val);
				}	
			}
		}

		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_SPECULARTXTCALIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, XMLKEY_REF_GEN);
			int count = gclist.size();
			if(count > 0) {
				specularTxtcAList.ensureCapacity(count);
				for(Element gc : gclist){
					aval = gc.getAttribute("Value");
					int val = resolveRefIndex(aval, refIndexMap);
					specularTxtcAList.add(val);
				}	
			}
		}

		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_DIFFUSETXTCBLIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, XMLKEY_REF_GEN);
			int count = gclist.size();
			if(count > 0) {
				diffuseTxtcBList.ensureCapacity(count);
				for(Element gc : gclist){
					aval = gc.getAttribute("Value");
					int val = resolveRefIndex(aval, refIndexMap);
					diffuseTxtcBList.add(val);
				}	
			}
		}

		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_SPECULARTXTCBLIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, XMLKEY_REF_GEN);
			int count = gclist.size();
			if(count > 0) {
				specularTxtcBList.ensureCapacity(count);
				for(Element gc : gclist){
					aval = gc.getAttribute("Value");
					int val = resolveRefIndex(aval, refIndexMap);
					specularTxtcBList.add(val);
				}	
			}
		}

		child = XMLReader.getFirstChildElementWithTag(xml_element, XMLKEY_BONEDELTALIST);
		if(child != null){
			List<Element> gclist = XMLReader.getChildElementsWithTag(child, XMLKEY_REF_GEN);
			int count = gclist.size();
			if(count > 0) {
				boneDeltaList.ensureCapacity(count);
				for(Element gc : gclist){
					aval = gc.getAttribute("Value");
					int val = resolveRefIndex(aval, refIndexMap);
					boneDeltaList.add(val);
				}	
			}
		}
		aval = xml_element.getAttribute(XMLKEY_SHOEMATERIAL);
		if((aval != null) && (!aval.isEmpty())) shoeMaterial = aval;

		return true;
	}
	
	public static CASPart readBinary(BufferReference dat) {
		if(dat == null) return null;
		CASPart str = new CASPart();
		if(!str.readBinary_internal(dat)) return null;
		return str;
	}
	
	public static CASPart readXMLNode(Element xml_element, String wd) throws IOException {
		if(xml_element == null) return null;
		CASPart str = new CASPart();
		if(!str.readXMLNode_internal(xml_element, wd)) return null;
		return str;
	}
	
	/*----- Write -----*/
	
	public int getBinarySize() {
		int size = BASE_BIN_SIZE;
		for(XmlPreset xmlPresets : xmlPresets){
			size += xmlPresets.getBinarySize();
		}
		size += (partName.length() << 1);
		size += vpxyList.size();
		for(CASLodInfo lodList : lodList){
			size += lodList.getBinarySize();
		}
		size += diffuseTxtcAList.size();
		size += specularTxtcAList.size();
		size += diffuseTxtcBList.size();
		size += specularTxtcBList.size();
		size += boneDeltaList.size();
		size += (shoeMaterial.length() << 1);
		size += (tgiTable.size() << 4);
		return size;
	}
	
	public FileBuffer writeBinary(boolean byteOrder) {
		FileBuffer buff = new FileBuffer(getBinarySize(), byteOrder);
		writeBinaryTo(buff);
		return buff;
	}
	
	public int writeBinaryTo(FileBuffer target) {
		if(target == null) return 0;
		long stPos = target.getFileSize();
		
		int xmlPresetCount = xmlPresets.size();
		int vpxyCount = vpxyList.size();
		int lodCount = lodList.size();
		int diffuseTxtcACount = diffuseTxtcAList.size();
		int specularTxtcACount = specularTxtcAList.size();
		int diffuseTxtcBCount = diffuseTxtcBList.size();
		int specularTxtcBCount = specularTxtcBList.size();
		int boneDeltaCount = boneDeltaList.size();
		int tgiCount = tgiTable.size();
		
		target.addToFile(DEFO_FILE_WRITE_VERSION);
		long offPos = target.getFileSize();
		
		target.addToFile(0); //TGI Offset placeholder
		target.addToFile(xmlPresetCount);
		for(XmlPreset xmlPresets : xmlPresets){
			xmlPresets.writeBinaryTo(target);
		}
		MaxisTypes.serializeMaxis7StringTo(partName, target);
		target.addToFile(Float.floatToRawIntBits(sortPriority));
		target.addToFile(unkA);
		target.addToFile(clothingType);
		target.addToFile(partFlags);
		target.addToFile(ageGenderFlags);
		target.addToFile(category);
		target.addToFile(nakedRefIndex);
		target.addToFile(parentRefIndex);
		target.addToFile(fatBlendRefIndex);
		target.addToFile(fitBlendRefIndex);
		target.addToFile(thinBlendRefIndex);
		target.addToFile(specialBlendRefIndex);
		target.addToFile(unkB);
		target.addToFile(vpxyCount);
		for(int vpxyRefIndex : vpxyList){
			target.addToFile((byte)vpxyRefIndex);
		}
		target.addToFile(lodCount);
		for(CASLodInfo lodList : lodList){
			lodList.writeBinaryTo(target);
		}
		target.addToFile(diffuseTxtcACount);
		for(int refIndex : diffuseTxtcAList){
			target.addToFile((byte)refIndex);
		}
		target.addToFile(specularTxtcACount);
		for(int refIndex : specularTxtcAList){
			target.addToFile((byte)refIndex);
		}
		target.addToFile(diffuseTxtcBCount);
		for(int refIndex : diffuseTxtcBList){
			target.addToFile((byte)refIndex);
		}
		target.addToFile(specularTxtcBCount);
		for(int refIndex : specularTxtcBList){
			target.addToFile((byte)refIndex);
		}
		target.addToFile(boneDeltaCount);
		for(int refIndex : boneDeltaList){
			target.addToFile((byte)refIndex);
		}
		MaxisTypes.serializeMaxis7StringTo(shoeMaterial, target);
		
		long tgiPos = target.getFileSize();
		target.addToFile(tgiCount);
		for(MaxisResRef resRef : tgiTable){
			MaxisResKey resKey = resRef.getKey();
			resKey.writeBinIGT(target);
		}
		
		int tgiOff = (int)(tgiPos - offPos - 4);
		target.replaceInt(tgiOff, offPos);

		return (int)(target.getFileSize() - stPos);
	}

	private String resolveXMLOutReference(int index) {
		if(index < 0) return Integer.toString(index);
		if(index >= tgiTable.size()) return Integer.toString(index);
		
		MaxisResRef ref = tgiTable.get(index);
		String uname = ref.getUniqueName();
		if(uname == null) {
			MaxisResKey key = ref.getKey();
			ref.setUniqueName(String.format("%08x_%08x_%016x", key.getTypeId(), key.getGroupId(), key.getInstanceId()));
			uname = ref.getUniqueName();
		}
		
		return uname;
	}
	
	public void writeXMLNode(Writer out, String indent, String wd) throws IOException {
		writeXMLNode(out, indent, null, wd);
	}
	
	public void writeXMLNode(Writer out, String indent, String varName, String wd) throws IOException {
		if(out == null) return;
		if(indent == null) indent = "";
		
		out.write(indent);
		out.write(String.format("<%s", XML_NODE_NAME));
		if(varName != null){
			out.write(String.format(" VarName=\"%s\"", varName));
		}
		out.write(String.format(" %s=\"%s\"", XMLKEY_PARTNAME, partName));
		out.write(String.format(" %s=\"%.3f\"", XMLKEY_SORTPRIORITY, sortPriority));
		//out.write(String.format(" %s=\"0x%02x\"", XMLKEY_UNKA, unkA));
		out.write(String.format(" %s=\"%s\"", XMLKEY_CLOTHINGTYPE, ClothingType.stringFromValue(clothingType)));
		out.write(String.format(" %s=\"%s\"", XMLKEY_PARTFLAGS, CASPartType.stringFromValue(partFlags)));
		out.write(String.format(" %s=\"%s\"", XMLKEY_AGEGENDERFLAGS, CASAgeGenderFlags.stringFromValue(ageGenderFlags)));
		out.write(String.format(" %s=\"%s\"", XMLKEY_CATEGORY, OutfitCategories.stringFromValue(category)));
		//out.write(String.format(" %s=\"0x%08x\"", XMLKEY_UNKB, unkB));
		out.write(String.format(" %s=\"%s\"", XMLKEY_SHOEMATERIAL, shoeMaterial));
		out.write(">\n");
		
		//Move these to their own list
		out.write(indent + "\t<" + XMLKEY_COMMON_REFS + ">\n");
		out.write(indent + String.format("\t\t<%s Value=\"%s\"/>\n", XMLKEY_NAKEDREFINDEX, resolveXMLOutReference(nakedRefIndex)));
		out.write(indent + String.format("\t\t<%s Value=\"%s\"/>\n", XMLKEY_PARENTREFINDEX, resolveXMLOutReference(parentRefIndex)));
		out.write(indent + String.format("\t\t<%s Value=\"%s\"/>\n", XMLKEY_FATBLENDREFINDEX, resolveXMLOutReference(fatBlendRefIndex)));
		out.write(indent + String.format("\t\t<%s Value=\"%s\"/>\n", XMLKEY_FITBLENDREFINDEX, resolveXMLOutReference(fitBlendRefIndex)));
		out.write(indent + String.format("\t\t<%s Value=\"%s\"/>\n", XMLKEY_THINBLENDREFINDEX, resolveXMLOutReference(thinBlendRefIndex)));
		out.write(indent + String.format("\t\t<%s Value=\"%s\"/>\n", XMLKEY_SPECIALBLENDREFINDEX, resolveXMLOutReference(specialBlendRefIndex)));
		out.write(indent + "\t</" + XMLKEY_COMMON_REFS + ">\n");
		
		int i = 0;
		out.write(indent + "\t<" + XMLKEY_XMLPRESETS + ">\n");
		for(XmlPreset xmlPresets : xmlPresets){
			String xmloutPath = wd + File.separator + this.partName + "_present_" + String.format("%02d", i) + ".xml";
			i++;
			xmlPresets.writeXMLNode(out, indent + "\t\t", null, wd, xmloutPath);
		}
		out.write(indent + "\t</" + XMLKEY_XMLPRESETS + ">\n");
		
		if(!vpxyList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_VPXYLIST + ">\n");
			for(int vpxyRefIndex : vpxyList){
				out.write(String.format(indent + "\t\t<%s Value=\"%s\"/>\n", XMLKEY_REF_GEN, resolveXMLOutReference(vpxyRefIndex)));
			}
			out.write(indent + "\t</" + XMLKEY_VPXYLIST + ">\n");	
		}
		
		if(!lodList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_LODLIST + ">\n");
			for(CASLodInfo lodList : lodList){
				lodList.writeXMLNode(out, indent + "\t\t", null);
			}
			out.write(indent + "\t</" + XMLKEY_LODLIST + ">\n");	
		}
		
		if(!diffuseTxtcAList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_DIFFUSETXTCALIST + ">\n");
			for(int refIndex : diffuseTxtcAList){
				out.write(String.format(indent + "\t\t<%s Value=\"%s\"/>\n", XMLKEY_REF_GEN, resolveXMLOutReference(refIndex)));
			}
			out.write(indent + "\t</" + XMLKEY_DIFFUSETXTCALIST + ">\n");	
		}
		
		if(!specularTxtcAList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_SPECULARTXTCALIST + ">\n");
			for(int refIndex : specularTxtcAList){
				out.write(String.format(indent + "\t\t<%s Value=\"%s\"/>\n", XMLKEY_REF_GEN, resolveXMLOutReference(refIndex)));
			}
			out.write(indent + "\t</" + XMLKEY_SPECULARTXTCALIST + ">\n");	
		}
		
		if(!diffuseTxtcBList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_DIFFUSETXTCBLIST + ">\n");
			for(int refIndex : diffuseTxtcBList){
				out.write(String.format(indent + "\t\t<%s Value=\"%s\"/>\n", XMLKEY_REF_GEN, resolveXMLOutReference(refIndex)));
			}
			out.write(indent + "\t</" + XMLKEY_DIFFUSETXTCBLIST + ">\n");	
		}
		
		if(!specularTxtcBList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_SPECULARTXTCBLIST + ">\n");
			for(int refIndex : specularTxtcBList){
				out.write(String.format(indent + "\t\t<%s Value=\"%s\"/>\n", XMLKEY_REF_GEN, resolveXMLOutReference(refIndex)));
			}
			out.write(indent + "\t</" + XMLKEY_SPECULARTXTCBLIST + ">\n");	
		}
		
		if(!boneDeltaList.isEmpty()) {
			out.write(indent + "\t<" + XMLKEY_BONEDELTALIST + ">\n");
			for(int refIndex : boneDeltaList){
				out.write(String.format(indent + "\t\t<%s Value=\"%s\"/>\n", XMLKEY_REF_GEN, resolveXMLOutReference(refIndex)));
			}
			out.write(indent + "\t</" + XMLKEY_BONEDELTALIST + ">\n");	
		}

		out.write(indent + "\t<" + XMLKEY_TGITABLE + ">\n");
		for(MaxisResRef resRef : tgiTable){
			resRef.writeXMLNode(out, indent + "\t\t");
		}
		out.write(indent + "\t</" + XMLKEY_TGITABLE + ">\n");
		
		out.write(indent);
		out.write(String.format("</%s>\n", XML_NODE_NAME));
	}

	/*----- Debug -----*/
	
	public static void main(String[] args) {
		String inpath = args[0];
		String outstem = args[1];
		
		try {
			FileBuffer infile = FileBuffer.createBuffer(inpath, false);
			CASPart casp = CASPart.readBinary(infile.getReferenceAt(0L));
			
			String outdir = outstem.substring(0, outstem.lastIndexOf(File.separator));
			
			String xmlpath = outstem + ".xml";
			BufferedWriter bw = new BufferedWriter(new FileWriter(xmlpath));
			bw.write("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n");
			casp.writeXMLNode(bw, "", outdir);
			bw.close();
			
			//Try to reserialize
			Document doc = XMLReader.readXMLStatic(xmlpath);
			NodeList nl = doc.getChildNodes();
			int nCount = nl.getLength();
			Element root = null;
			for(int i = 0; i < nCount; i++) {
				Node nn = nl.item(i);
				if(nn.getNodeType() == Node.ELEMENT_NODE) {
					Element child = (Element)nn;
					if(child.getTagName().equals(XML_NODE_NAME)) {
						root = child;
						break;
					}
				}
			}
			
			casp = CASPart.readXMLNode(root, outdir);
			String binpath = outstem + ".casp";
			FileBuffer outbuff = casp.writeBinary(false);
			outbuff.writeFile(binpath);
		}
		catch(Exception ex) {
			ex.printStackTrace();
			System.exit(1);
		}
		
	}
	
}
